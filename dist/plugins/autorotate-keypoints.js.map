{"version":3,"file":"autorotate-keypoints.js","sources":["../../src/plugins/autorotate-keypoints/index.js"],"sourcesContent":["import * as THREE from 'three';\nimport { AbstractPlugin, CONSTANTS, PSVError, utils } from '../..';\n\n/**\n * @typedef {Object} PSV.plugins.AutorotateKeypointsPlugin.KeypointObject\n * @property {PSV.ExtendedPosition} [position]\n * @property {string} [markerId] - use the position and tooltip of a marker\n * @property {number} [pause=0] - pause the animation when reaching this point, will display the tooltip if available\n * @property {string|{content: string, position: string}} [tooltip]\n */\n\n/**\n * @typedef {PSV.ExtendedPosition|string|PSV.plugins.AutorotateKeypointsPlugin.KeypointObject} PSV.plugins.AutorotateKeypointsPlugin.Keypoint\n * @summary Definition of keypoints for automatic rotation, can be a position object, a marker id or an keypoint object\n */\n\n/**\n * @typedef {Object} PSV.plugins.AutorotateKeypointsPlugin.Options\n * @property {boolean} [startFromClosest=true] - start from the closest keypoint instead of the first keypoint\n * @property {PSV.plugins.AutorotateKeypointsPlugin.Keypoint[]} keypoints\n */\n\n\nconst NUM_STEPS = 16;\n\nfunction serializePt(position) {\n  return [position.longitude, position.latitude];\n}\n\n\n/**\n * @summary Replaces the standard autorotate animation by a smooth transition between multiple points\n * @extends PSV.plugins.AbstractPlugin\n * @memberof PSV.plugins\n */\nexport class AutorotateKeypointsPlugin extends AbstractPlugin {\n\n  static id = 'autorotate-keypoints';\n\n  /**\n   * @param {PSV.Viewer} psv\n   * @param {PSV.plugins.AutorotateKeypointsPlugin.Options} [options]\n   */\n  constructor(psv, options) {\n    super(psv);\n\n    /**\n     * @member {Object}\n     * @property {number} idx -  current index in keypoints\n     * @property {number[][]} curve - curve between idx and idx + 1\n     * @property {number[]} startStep - start point of the current step\n     * @property {number[]} endStep - end point of the current step\n     * @property {number} startTime - start time of the current step\n     * @property {number} stepDuration - expected duration of the step\n     * @property {number} remainingPause - time remaining for the pause\n     * @property {number} lastTime - previous timestamp in render loop\n     * @property {PSV.components.Tooltip} tooltip - currently displayed tooltip\n     * @private\n     */\n    this.state = {};\n\n    /**\n     * @member {PSV.plugins.AutorotateKeypointsPlugin.Options}\n     * @private\n     */\n    this.config = {\n      startFromClosest: true,\n      ...options,\n    };\n\n    /**\n     * @type {PSV.plugins.AutorotateKeypointsPlugin.Keypoint[]} keypoints\n     */\n    this.keypoints = null;\n\n    /**\n     * @type {PSV.plugins.MarkersPlugin}\n     * @private\n     */\n    this.markers = null;\n  }\n\n  /**\n   * @package\n   */\n  init() {\n    super.init();\n\n    this.markers = this.psv.getPlugin('markers');\n\n    if (this.config.keypoints) {\n      this.setKeypoints(this.config.keypoints);\n      delete this.config.keypoints;\n    }\n\n    this.psv.on(CONSTANTS.EVENTS.AUTOROTATE, this);\n    this.psv.on(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n  }\n\n  /**\n   * @package\n   */\n  destroy() {\n    this.psv.off(CONSTANTS.EVENTS.AUTOROTATE, this);\n    this.psv.off(CONSTANTS.EVENTS.BEFORE_RENDER, this);\n\n    delete this.markers;\n    delete this.keypoints;\n\n    super.destroy();\n  }\n\n  /**\n   * @private\n   */\n  handleEvent(e) {\n    if (e.type === CONSTANTS.EVENTS.AUTOROTATE) {\n      this.__configure();\n    }\n    else if (e.type === CONSTANTS.EVENTS.BEFORE_RENDER) {\n      this.__beforeRender(e.args[0]);\n    }\n  }\n\n  /**\n   * @summary Changes the keypoints\n   * @param {PSV.plugins.AutorotateKeypointsPlugin.Keypoint[]} keypoints\n   */\n  setKeypoints(keypoints) {\n    if (keypoints?.length < 2) {\n      throw new PSVError('At least two points are required');\n    }\n\n    this.keypoints = utils.clone(keypoints);\n\n    if (this.keypoints) {\n      this.keypoints.forEach((pt, i) => {\n        if (typeof pt === 'string') {\n          pt = { markerId: pt };\n        }\n        else if (utils.isExtendedPosition(pt)) {\n          pt = { position: pt };\n        }\n        if (pt.markerId) {\n          if (!this.markers) {\n            throw new PSVError(`Keypoint #${i} references a marker but the markers plugin is not loaded`);\n          }\n          const marker = this.markers.getMarker(pt.markerId);\n          pt.position = serializePt(marker.props.position);\n        }\n        else if (pt.position) {\n          pt.position = serializePt(this.psv.dataHelper.cleanPosition(pt.position));\n        }\n        else {\n          throw new PSVError(`Keypoint #${i} is missing marker or position`);\n        }\n\n        if (typeof pt.tooltip === 'string') {\n          pt.tooltip = { content: pt.tooltip };\n        }\n\n        this.keypoints[i] = pt;\n      });\n    }\n\n    this.__configure();\n  }\n\n  /**\n   * @private\n   */\n  __configure() {\n    if (!this.psv.isAutorotateEnabled() || !this.keypoints) {\n      this.__hideTooltip();\n      this.state = {};\n      return;\n    }\n\n    // cancel core rotation\n    this.psv.dynamics.position.stop();\n\n    this.state = {\n      idx           : -1,\n      curve         : [],\n      startStep     : null,\n      endStep       : null,\n      startTime     : null,\n      stepDuration  : null,\n      remainingPause: null,\n      lastTime      : null,\n      tooltip       : null,\n    };\n\n    if (this.config.startFromClosest) {\n      const currentPosition = serializePt(this.psv.getPosition());\n      const index = this.__findMinIndex(this.keypoints, (keypoint) => {\n        return utils.greatArcDistance(keypoint.position, currentPosition);\n      });\n\n      this.keypoints.push(...this.keypoints.splice(0, index));\n    }\n  }\n\n  /**\n   * @private\n   */\n  __beforeRender(timestamp) {\n    if (this.psv.isAutorotateEnabled()) {\n      // initialisation\n      if (!this.state.startTime) {\n        this.state.endStep = serializePt(this.psv.getPosition());\n        this.__nextStep();\n\n        this.state.startTime = timestamp;\n        this.state.lastTime = timestamp;\n      }\n\n      this.__nextFrame(timestamp);\n    }\n  }\n\n  /**\n   * @private\n   */\n  __incrementIdx() {\n    this.state.idx++;\n    if (this.state.idx === this.keypoints.length) {\n      this.state.idx = 0;\n    }\n  }\n\n  /**\n   * @private\n   */\n  __showTooltip() {\n    const keypoint = this.keypoints[this.state.idx];\n\n    if (keypoint.tooltip) {\n      const position = this.psv.dataHelper.vector3ToViewerCoords(this.psv.prop.direction);\n\n      this.state.tooltip = this.psv.tooltip.create({\n        content : keypoint.tooltip.content,\n        position: keypoint.tooltip.position,\n        top     : position.y,\n        left    : position.x,\n      });\n    }\n    else if (keypoint.markerId) {\n      const marker = this.markers.getMarker(keypoint.markerId);\n      marker.showTooltip();\n      this.state.tooltip = marker.tooltip;\n    }\n  }\n\n  /**\n   * @private\n   */\n  __hideTooltip() {\n    if (this.state.tooltip) {\n      const keypoint = this.keypoints[this.state.idx];\n\n      if (keypoint.tooltip) {\n        this.state.tooltip.hide();\n      }\n      else if (keypoint.markerId) {\n        const marker = this.markers.getMarker(keypoint.markerId);\n        marker.hideTooltip();\n      }\n\n      this.state.tooltip = null;\n    }\n  }\n\n  /**\n   * @private\n   */\n  __nextPoint() {\n    // get the 4 points necessary to compute the current movement\n    // the two points of the current segments and one point before and after\n    const workPoints = [];\n    if (this.state.idx === -1) {\n      const currentPosition = serializePt(this.psv.getPosition());\n      workPoints.push(\n        currentPosition,\n        currentPosition,\n        this.keypoints[0].position,\n        this.keypoints[1].position\n      );\n    }\n    else {\n      for (let i = -1; i < 3; i++) {\n        const keypoint = this.state.idx + i < 0\n          ? this.keypoints[this.keypoints.length - 1]\n          : this.keypoints[(this.state.idx + i) % this.keypoints.length];\n        workPoints.push(keypoint.position);\n      }\n    }\n\n    // apply offsets to avoid crossing the origin\n    const workVectors = [new THREE.Vector2(workPoints[0][0], workPoints[0][1])];\n\n    let k = 0;\n    for (let i = 1; i <= 3; i++) {\n      const d = workPoints[i - 1][0] - workPoints[i][0];\n      if (d > Math.PI) { // crossed the origin left to right\n        k += 1;\n      }\n      else if (d < -Math.PI) { // crossed the origin right to left\n        k -= 1;\n      }\n      if (k !== 0 && i === 1) {\n        // do not modify first point, apply the reverse offset the the previous point instead\n        workVectors[0].x -= k * 2 * Math.PI;\n        k = 0;\n      }\n      workVectors.push(new THREE.Vector2(workPoints[i][0] + k * 2 * Math.PI, workPoints[i][1]));\n    }\n\n    const curve = new THREE.SplineCurve(workVectors)\n      .getPoints(NUM_STEPS * 3)\n      .map(p => ([p.x, p.y]));\n\n    // debugCurve(this.markers, curve, NUM_STEPS);\n\n    // only keep the curve for the current movement\n    this.state.curve = curve.slice(NUM_STEPS + 1, NUM_STEPS * 2 + 1);\n\n    if (this.state.idx !== -1) {\n      this.state.remainingPause = this.keypoints[this.state.idx].pause;\n\n      if (this.state.remainingPause) {\n        this.__showTooltip();\n      }\n      else {\n        this.__incrementIdx();\n      }\n    }\n    else {\n      this.__incrementIdx();\n    }\n  }\n\n  /**\n   * @private\n   */\n  __nextStep() {\n    if (this.state.curve.length === 0) {\n      this.__nextPoint();\n\n      // reset transformation made to the previous point\n      this.state.endStep[0] = utils.parseAngle(this.state.endStep[0]);\n    }\n\n    // target next point\n    this.state.startStep = this.state.endStep;\n    this.state.endStep = this.state.curve.shift();\n\n    // compute duration from distance and speed\n    const distance = utils.greatArcDistance(this.state.startStep, this.state.endStep);\n    this.state.stepDuration = distance * 1000 / Math.abs(this.psv.config.autorotateSpeed);\n\n    if (distance === 0) { // edge case\n      this.__nextStep();\n    }\n  }\n\n  /**\n   * @private\n   */\n  __nextFrame(timestamp) {\n    const ellapsed = timestamp - this.state.lastTime;\n    this.state.lastTime = timestamp;\n\n    // currently paused\n    if (this.state.remainingPause) {\n      this.state.remainingPause = Math.max(0, this.state.remainingPause - ellapsed);\n      if (this.state.remainingPause > 0) {\n        return;\n      }\n      else {\n        this.__hideTooltip();\n        this.__incrementIdx();\n        this.state.startTime = timestamp;\n      }\n    }\n\n    let progress = (timestamp - this.state.startTime) / this.state.stepDuration;\n    if (progress >= 1) {\n      this.__nextStep();\n      progress = 0;\n      this.state.startTime = timestamp;\n    }\n\n    this.psv.rotate({\n      longitude: this.state.startStep[0] + (this.state.endStep[0] - this.state.startStep[0]) * progress,\n      latitude : this.state.startStep[1] + (this.state.endStep[1] - this.state.startStep[1]) * progress,\n    });\n  }\n\n  /**\n   * @private\n   */\n  __findMinIndex(array, mapper) {\n    let idx = 0;\n    let current = Number.MAX_VALUE;\n\n    array.forEach((item, i) => {\n      const value = mapper ? mapper(item) : item;\n      if (value < current) {\n        current = value;\n        idx = i;\n      }\n    });\n\n    return idx;\n  }\n\n}\n"],"names":["NUM_STEPS","serializePt","position","longitude","latitude","AutorotateKeypointsPlugin","psv","options","state","config","startFromClosest","keypoints","markers","init","getPlugin","setKeypoints","on","CONSTANTS","EVENTS","AUTOROTATE","BEFORE_RENDER","destroy","off","handleEvent","e","type","__configure","__beforeRender","args","length","PSVError","utils","clone","forEach","pt","i","markerId","isExtendedPosition","marker","getMarker","props","dataHelper","cleanPosition","tooltip","content","isAutorotateEnabled","__hideTooltip","dynamics","stop","idx","curve","startStep","endStep","startTime","stepDuration","remainingPause","lastTime","currentPosition","getPosition","index","__findMinIndex","keypoint","greatArcDistance","push","splice","timestamp","__nextStep","__nextFrame","__incrementIdx","__showTooltip","vector3ToViewerCoords","prop","direction","create","top","y","left","x","showTooltip","hide","hideTooltip","__nextPoint","workPoints","workVectors","THREE","Vector2","k","d","Math","PI","SplineCurve","getPoints","map","p","slice","pause","parseAngle","shift","distance","abs","autorotateSpeed","ellapsed","max","progress","rotate","array","mapper","current","Number","MAX_VALUE","item","value","AbstractPlugin","id"],"mappings":"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"}